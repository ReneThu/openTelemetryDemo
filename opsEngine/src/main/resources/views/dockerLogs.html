<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Docker Logs</title>
    <style>
        body {
            font-family: monospace;
            background-color: #000;
            color: #fff; /* Default color for text */
            margin: 0;
            padding: 0;
        }
        #log-container {
            padding: 10px;
            white-space: pre-wrap;
            overflow-y: auto;
            height: 100vh;
        }
    </style>
    <!-- Include ansi_up via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/ansi_up@5.0.0/ansi_up.min.js"></script>
</head>
<body>
<div id="log-container"></div>
<script>
    // Access ansi_up from the global window object
    const ansi_up = new AnsiUp();

    const logContainer = document.getElementById('log-container');
    const socket = new WebSocket(`ws://${window.location.host}/docker/logs/${window.location.pathname.split('/').pop()}`);

    function renderLogLine(data) {
        try {
            console.log('Raw data received:', data);

            let sanitizedData = data.replace(/[^ -~\u001b\u0009\u000a\u000d]/g, '');

            sanitizedData = sanitizedData.replace(/\x1b\[.*?Hw Enable Watch\x1b\[.*?m/g, '');

            console.log('Sanitized data:', sanitizedData);

            return ansi_up.ansi_to_html(sanitizedData);
        } catch (error) {
            console.error('Error rendering log line:', error, 'Input:', data);
            return `<span style="color: red;">Error rendering log line: ${error.message}</span>`;
        }
    }


    // Handle incoming WebSocket messages
    socket.onmessage = (event) => {
        const logLine = document.createElement('div');
        // Convert sanitized ANSI escape codes to HTML
        logLine.innerHTML = renderLogLine(event.data);
        logContainer.appendChild(logLine);
        logContainer.scrollTop = logContainer.scrollHeight; // Auto-scroll to the latest log
    };

    // Handle WebSocket errors
    socket.onerror = (error) => {
        console.error('WebSocket error:', error);
    };

    // Handle WebSocket closure
    socket.onclose = () => {
        const closedMessage = document.createElement('div');
        closedMessage.textContent = 'Connection closed.';
        closedMessage.style.color = 'red';
        logContainer.appendChild(closedMessage);
    };
</script>
</body>
</html>
